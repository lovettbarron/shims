import{s as t,h as e}from"hastscript";import n from"fs";import{fromMarkdown as o}from"mdast-util-from-markdown";import{toHast as r}from"mdast-util-to-hast";function i(){return i=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)({}).hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},i.apply(null,arguments)}const s={html:"http://www.w3.org/1999/xhtml",mathml:"http://www.w3.org/1998/Math/MathML",svg:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function d(n,o){const r=function(n,o){switch(n.nodeType){case 1:return function(n,o){const r=n.namespaceURI,i=r===s.svg?t:e,d=r===s.html?n.tagName.toLowerCase():n.tagName,l=r===s.html&&"template"===d?n.content:n,h=n.getAttributeNames(),a={};let f=-1;for(;++f<h.length;)a[h[f]]=n.getAttribute(h[f])||"";return i(d,a,c(l,o))}(n,o);case 3:return function(t){return{type:"text",value:t.nodeValue||""}}(n);case 8:return function(t){return{type:"comment",value:t.nodeValue||""}}(n);case 9:case 11:return function(t,e){return{type:"root",children:c(t,e)}}(n,o);case 10:return{type:"doctype"};default:return}}(n,o);return r&&o.afterTransform&&o.afterTransform(n,r),r}function c(t,e){const n=t.childNodes,o=[];let r=-1;for(;++r<n.length;){const t=d(n[r],e);void 0!==t&&o.push(t)}return o}const l=new DOMParser,h=function(t){if(null==t)return f;if("function"==typeof t)return a(t);if("object"==typeof t)return Array.isArray(t)?function(t){const e=[];let n=-1;for(;++n<t.length;)e[n]=h(t[n]);return a(function(...t){let n=-1;for(;++n<e.length;)if(e[n].apply(this,t))return!0;return!1})}(t):function(t){const e=t;return a(function(n){const o=n;let r;for(r in t)if(o[r]!==e[r])return!1;return!0})}(t);if("string"==typeof t)return e=t,a(function(t){return t&&t.type===e});var e;throw new Error("Expected function, string, or object as test")};function a(t){return function(e,n,o){return Boolean(function(t){return null!==t&&"object"==typeof t&&"type"in t}(e)&&t.call(this,e,"number"==typeof n?n:void 0,o||void 0))}}function f(){return!0}const u=[],g=!1;function p(t={}){return{openEmbededInNewTab:void 0===t.openEmbededInNewTab||t.openEmbededInNewTab,renderMode:void 0===t.renderMode?"canvas":t.renderMode,canvasBuffer:void 0===t.canvasBuffer?30:t.canvasBuffer,nodeStrokeWidth:void 0===t.nodeStrokeWidth?3:t.nodeStrokeWidth,lineStrokeWidth:void 0===t.lineStrokeWidth?5:t.lineStrokeWidth}}const m=[];function w(t){let e=m.every(t=>t.complete);if(console.group("Images loading",m,e),m.length<1)return t();e?t():w(t)}function y(e,n){const s=p(n),{canvasWidth:d,canvasHeight:c,offsetX:l,offsetY:h}=function(t){let e=Infinity,n=Infinity,o=-Infinity,r=-Infinity;return t.getNodes().forEach(t=>{e=Math.min(e,t.x),n=Math.min(n,t.y),o=Math.max(o,t.x+t.width),r=Math.max(r,t.y+t.height)}),{canvasWidth:o-e,canvasHeight:r-n,offsetX:-e,offsetY:-n}}(e),a=function(e,n,o){const r=p(void 0);console.log(r);const s=i({},{version:"1.1",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":r.lineStrokeWidth,"fill-rule":"evenodd",fill:"currentColor",stroke:"currentColor"},{width:e,height:n,viewBox:`0 0 ${e} ${n}`});return t("svg",s)}(d+l,c+h);return null===a?null:(e.getNodes().forEach(e=>{!async function(e,n,i){const s=p(i);let d="rgba(255, 255, 255, .5)",c="rgba(0,0,0,1)";"1"===n.color?(d="rgba(255, 0, 0, .5)",c="rgba(255,0,0,1)"):"2"===n.color?(d="rgba(255, 100, 0, .5)",c="rgba(255,100,0,1)"):"3"===n.color?(d="rgba(255, 255, 0, .5)",c="rgba(255,255,0,1)"):"4"===n.color?(d="rgba(0, 255, 100, .5)",c="rgba(0,100,0,1)"):"5"===n.color?(d="rgba(0, 255, 255, .5)",c="rgba(0,255,255,1)"):"6"===n.color&&(d="rgba(100, 10, 100, .5)",c="rgba(100,10,100,1)");const l=t("g"),h=t("rect",{x:n.x+e.properties.width/2,y:n.y+e.properties.height/2,width:n.width,height:n.height,rx:5,ry:5,stroke:c,fill:d,"stroke-width":s.lineStrokeWidth});l.children.push(h),async function(e,n){if("file"===n.type&&e&&n.file.match(/\.(jpg|jpeg|png|gif)$/i)){const o=t("image",{x:n.x,y:n.y,width:n.width,height:n.height,"xlink:href":n.file});e.children.push(o)}}(e,n),async function(e,n){if("file"===n.type&&e&&n.file.match(/\.(md|mdx)$/i)){const i=await fetch(n.file),s=await i.text(),d=o(s),c=r(d),l=t("foreignObject",{x:n.x,y:n.y,width:n.width,height:n.height});l.children.push(c),e.children.push(l)}}(e,n),e.children.push(l)}(a,e,s)}),e.getEdges().forEach(n=>{const o=e.getNodes().find(t=>t.id===n.fromNode),r=e.getNodes().find(t=>t.id===n.toNode);void 0!==r&&void 0!==o&&function(e,n,o,r,i){const s=p(i);if(null===e||null==e)return;const d=e.properties.width||1,c=e.properties.height||1;if(o&&n){let i=o.x+("top"==r.fromSide||"bottom"==r.fromSide?o.width/2:o.width)+d/2,l=o.y+o.height/2+c/2,h=n.x+("top"==r.toSide||"bottom"==r.toSide?n.width/2:n.width)+d/2,a=n.y+n.height/2+c/2;"left"===r.fromSide?i=o.x+d/2:"top"===r.fromSide?l=o.y+c/2:"bottom"===r.fromSide&&(l=o.y+o.height+c/2),"right"===r.toSide?h=n.x+n.width+d/2:"top"===r.toSide?a=n.y+c/2:"bottom"===r.toSide?a=n.y+n.height+c/2:"left"===r.toSide&&(h=n.x+d/2);const f={x:i,y:a},u={x:h,y:l},g=t("path",{d:`M ${i} ${l} C ${f.x} ${f.y}, ${u.x} ${u.y}, ${h} ${a}`,stroke:"black","stroke-width":s.lineStrokeWidth,fill:"none"});e.children.push(g)}}(a,r,o,n,s)}),w(()=>function(t,e){const n=p(void 0);return console.log("Rendering",t,n),null}(a)))}var v=Object.defineProperty,b=(t,e,n)=>(((t,e,n)=>{e in t?v(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n})(t,"symbol"!=typeof e?e+"":e,n),n);class x{constructor(t,e){b(this,"nodes",[]),b(this,"edges",[]),t&&(this.nodes=t),e&&(this.edges=e)}addNode(t){if(this.nodes.find(e=>e.id===t.id))throw new Error("A node with the same ID already exists in this.nodes");this.nodes.push(t)}addEdge(t){if(this.edges.find(e=>e.id===t.id))throw new Error("An edge with the same ID already exists in this.edges");this.edges.push(t)}getNode(t){return this.nodes.find(e=>e.id===t)}getEdge(t){return this.edges.find(e=>e.id===t)}getNodes(){return this.nodes}getEdges(){return this.edges}removeNode(t){this.nodes=this.nodes.filter(e=>e.id!==t),this.edges=this.edges.filter(e=>e.fromNode!==t&&e.toNode!==t)}removeEdge(t){this.edges=this.edges.filter(e=>e.id!==t)}toString(){return JSON.stringify({nodes:this.nodes,edges:this.edges})}static fromString(t){const e=JSON.parse(t);return new x(e.nodes,e.edges)}}const S=()=>async t=>{const e=[];!function(t,n,o,r){let i,s,d;s="element",d=(t,n)=>{console.log(t,n),"img"===t.tagName&&void 0!==n&&(console.log("Adding",t),e.push(t))},i=void 0,function(t,e,n,o){let r;r="element";const i=h("element");!function t(e,o,r){const s=e&&"object"==typeof e?e:{};if("string"==typeof s.type){const t="string"==typeof s.tagName?s.tagName:"string"==typeof s.name?s.name:void 0;Object.defineProperty(d,"name",{value:"node ("+e.type+(t?"<"+t+">":"")+")"})}return d;function d(){let s,d,c,l=u;if(i(e,o,r[r.length-1]||void 0)&&(l=function(t){return Array.isArray(t)?t:"number"==typeof t?[!0,t]:null==t?u:[t]}(n(e,r)),l[0]===g))return l;if("children"in e&&e.children){const n=e;if(n.children&&"skip"!==l[0])for(d=0,c=r.concat(n);d>-1&&d<n.children.length;){if(s=t(n.children[d],d,c)(),s[0]===g)return s;d="number"==typeof s[1]?s[1]:d+1}}return l}}(t,void 0,[])()}(t,0,function(t,e){const n=e[e.length-1],o=n?n.children.indexOf(t):void 0;return d(t,o)})}(t);for(const t of e){const e=t.properties.src;console.log("Detected",e);let r=await k(e);console.log("Got markdown",r);const s=x.fromString(r);let c;console.log("Validate!",s),c=y(s,{}),console.log(c);const h=(n=`<img alt='' src='${c}' style='width:100%' />`,o={fragment:!0},d(o?.fragment?function(t){const e=document.createElement("template");return e.innerHTML=t,e.content}(n):l.parseFromString(n,"text/html"),{})||{type:"root",children:[]});t.properties=i({},t.properties),t.tagName="div",t.children=h.children}var n,o};async function k(t){let e="Loading";return t.trim().toLowerCase().startsWith("https://")||"undefined"!=typeof window?await fetch(t).then(t=>t.text()).then(t=>e=t):e=n.readFileSync(t,{encoding:"utf8",flag:"r"}),null===e?"":e}export{S as default,S as rehypeJsonCanvas};
//# sourceMappingURL=index.js.map
