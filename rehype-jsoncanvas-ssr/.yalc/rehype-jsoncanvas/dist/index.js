import e from"node:fs";import t from"node:path";import{s as n}from"hastscript";import{fromMarkdown as i}from"mdast-util-from-markdown";import{toHast as r}from"mdast-util-to-hast";function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(null,arguments)}var s=Object.defineProperty,d=(e,t,n)=>(((e,t,n)=>{t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class h{constructor(e,t){d(this,"nodes",[]),d(this,"edges",[]),e&&(this.nodes=e),t&&(this.edges=t)}addNode(e){if(this.nodes.find(t=>t.id===e.id))throw new Error("A node with the same ID already exists in this.nodes");this.nodes.push(e)}addEdge(e){if(this.edges.find(t=>t.id===e.id))throw new Error("An edge with the same ID already exists in this.edges");this.edges.push(e)}getNode(e){return this.nodes.find(t=>t.id===e)}getEdge(e){return this.edges.find(t=>t.id===e)}getNodes(){return this.nodes}getEdges(){return this.edges}removeNode(e){this.nodes=this.nodes.filter(t=>t.id!==e),this.edges=this.edges.filter(t=>t.fromNode!==e&&t.toNode!==e)}removeEdge(e){this.edges=this.edges.filter(t=>t.id!==e)}toString(){return JSON.stringify({nodes:this.nodes,edges:this.edges})}static fromString(e){const t=JSON.parse(e);return new h(t.nodes,t.edges)}}const a=function(e){if(null==e)return f;if("function"==typeof e)return l(e);if("object"==typeof e)return Array.isArray(e)?function(e){const t=[];let n=-1;for(;++n<e.length;)t[n]=a(e[n]);return l(function(...e){let n=-1;for(;++n<t.length;)if(t[n].apply(this,e))return!0;return!1})}(e):function(e){const t=e;return l(function(n){const i=n;let r;for(r in e)if(i[r]!==t[r])return!1;return!0})}(e);if("string"==typeof e)return t=e,l(function(e){return e&&e.type===t});var t;throw new Error("Expected function, string, or object as test")};function l(e){return function(t,n,i){return Boolean(function(e){return null!==e&&"object"==typeof e&&"type"in e}(t)&&e.call(this,t,"number"==typeof n?n:void 0,i||void 0))}}function f(){return!0}const c=[],u=!1;function g(e={}){return{openEmbededInNewTab:void 0===e.openEmbededInNewTab||e.openEmbededInNewTab,assetPath:void 0===e.assetPath?null:e.assetPath,ssrPath:void 0===e.ssrPath?"public":e.ssrPath,mdPath:void 0===e.mdPath?e.assetPath:e.mdPath,nodeStrokeWidth:void 0===e.nodeStrokeWidth?3:e.nodeStrokeWidth,lineStrokeWidth:void 0===e.lineStrokeWidth?5:e.lineStrokeWidth}}function p(e,t){const i=g(t),{canvasWidth:r,canvasHeight:s,offsetX:d,offsetY:h}=function(e){let t=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(const o of e.getNodes())t=Math.min(t,o.x),n=Math.min(n,o.y),i=Math.max(i,o.x+o.width),r=Math.max(r,o.y+o.height);return{canvasWidth:i-t,canvasHeight:r-n,offsetX:-t,offsetY:-n}}(e),a=function(e,t,i){const r=o({},{version:"1.1",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":g(void 0).lineStrokeWidth,"fill-rule":"evenodd",fill:"currentColor",stroke:"currentColor"},{width:"100%",height:"100%",renWidth:e,renHeight:t,viewBox:`0 0 ${e} ${t}`,preserveAspectRatio:"none"});return n("svg",r)}(r+d,s+h);if(null===a)return null;for(const t of e.getNodes())m(a,t,i);for(const t of e.getEdges()){const n=e.getNodes().find(e=>e.id===t.fromNode),r=e.getNodes().find(e=>e.id===t.toNode);void 0!==r&&void 0!==n&&y(a,r,n,t,i)}return a}async function m(e,o,s){const d=g(s);let h="rgba(255, 255, 255, .5)",a="rgba(0,0,0,1)";"1"===o.color?(h="rgba(255, 0, 0, .5)",a="rgba(255,0,0,1)"):"2"===o.color?(h="rgba(255, 100, 0, .5)",a="rgba(255,100,0,1)"):"3"===o.color?(h="rgba(255, 255, 0, .5)",a="rgba(255,255,0,1)"):"4"===o.color?(h="rgba(0, 255, 100, .5)",a="rgba(0,100,0,1)"):"5"===o.color?(h="rgba(0, 255, 255, .5)",a="rgba(0,255,255,1)"):"6"===o.color&&(h="rgba(100, 10, 100, .5)",a="rgba(100,10,100,1)");const l=n("g"),f=n("rect",{x:o.x+e.properties.renWidth/2,y:o.y+e.properties.renHeight/2,width:o.width,height:o.height,rx:5,ry:5,stroke:a,fill:h,"stroke-width":d.lineStrokeWidth});if(l.children.push(f),async function(e,i,r,o){const s=g(o);if(console.log("Test",s.assetPath?t.join(s.assetPath,r.file):r.file),"file"===r.type&&e&&r.file.match(/\.(jpg|jpeg|png|gif)$/i)){const o=s.assetPath?t.join(s.assetPath,r.file):r.file,d=n("image",{x:5+r.x+e.properties.renWidth/2,y:5+r.y+e.properties.renHeight/2,width:r.width-10,height:r.height-10,"xlink:href":o});i.children.push(d)}}(e,l,o,s),async function(e,t,o,s){if("file"===o.type&&e&&o.file.match(/\.(md|mdx)$/i)){const d=await w(o.file,s),h=i(d),a=r(h),l=n("foreignObject",{x:5+o.x+e.properties.renWidth/2,y:5+o.y+e.properties.renHeight/2,width:o.width-10,height:o.height-10});l.children.push(a),t.children.push(l)}}(e,l,o,s),o.label){const t=n("text",{x:o.x+5+e.properties.renWidth/2,y:o.y-10+e.properties.renHeight/2,"font-family":"monospace","font-size":20,"stroke-width":1},o.label);l.children.push(t)}if("text"===o.type&&o.text){const t=n("text",{x:o.x+5+e.properties.renWidth/2,y:o.y+5+o.height/2+e.properties.renHeight/2,"font-family":"monospace","font-size":20,"stroke-width":1},o.text);l.children.push(t)}e.children.push(l)}function y(e,t,i,r,o){const s=g(o);if(null==e)return;const d=e.properties.renWidth||1,h=e.properties.renHeight||1;if(i&&t){let o=i.x+("top"===r.fromSide||"bottom"===r.fromSide?i.width/2:i.width)+d/2,a=i.y+i.height/2+h/2,l=t.x+("top"===r.toSide||"bottom"===r.toSide?t.width/2:t.width)+d/2,f=t.y+t.height/2+h/2;"left"===r.fromSide?o=i.x+d/2:"top"===r.fromSide?a=i.y+h/2:"bottom"===r.fromSide&&(a=i.y+i.height+h/2),"right"===r.toSide?l=t.x+t.width+d/2:"top"===r.toSide?f=t.y+h/2:"bottom"===r.toSide?f=t.y+t.height+h/2:"left"===r.toSide&&(l=t.x+d/2);const c={x:o,y:f},u={x:l,y:a},g=n("path",{d:`M ${o} ${a} C ${c.x} ${c.y}, ${u.x} ${u.y}, ${l} ${f}`,stroke:"black","stroke-width":s.lineStrokeWidth,fill:"none"});e.children.push(g)}}const b=e=>async t=>{const n=[];!function(e,t,i,r){let o,s,d;s="element",d=(e,t)=>{"img"===e.tagName&&void 0!==t&&e.properties.src.includes(".canvas")&&n.push(e)},o=void 0,function(e,t,n,i){let r;r="element";const o=a("element");!function e(t,i,r){const s=t&&"object"==typeof t?t:{};if("string"==typeof s.type){const e="string"==typeof s.tagName?s.tagName:"string"==typeof s.name?s.name:void 0;Object.defineProperty(d,"name",{value:"node ("+t.type+(e?"<"+e+">":"")+")"})}return d;function d(){let s,d,h,a=c;if(o(t,i,r[r.length-1]||void 0)&&(a=function(e){return Array.isArray(e)?e:"number"==typeof e?[!0,e]:null==e?c:[e]}(n(t,r)),a[0]===u))return a;if("children"in t&&t.children){const n=t;if(n.children&&"skip"!==a[0])for(d=0,h=r.concat(n);d>-1&&d<n.children.length;){if(s=e(n.children[d],d,h)(),s[0]===u)return s;d="number"==typeof s[1]?s[1]:d+1}}return a}}(e,void 0,[])()}(e,0,function(e,t){const n=t[t.length-1],i=n?n.children.indexOf(e):void 0;return d(e,i)})}(t);for(const t of n){const n=t.properties.src,i=await w(n,e);if(i.length<1)return;const r=h.fromString(i);let s=null;if(console.log("Validate!",r),s=p(r,e),!s)return;t.properties=o({},t.properties),t.tagName="div",t.children=[],t.children.push(s)}};async function w(n,i){const r=g(i);let o="";const s=n.trim().toLowerCase(),d=s.slice((Math.max(0,s.lastIndexOf("."))||Number.POSITIVE_INFINITY)+1);if(s.startsWith("https://")||"undefined"!=typeof window)await fetch(n).then(e=>e.text()).then(e=>{o=e});else if(void 0!==r.ssrPath){let i=[process.cwd()];r.ssrPath&&"md"!==d&&i.push(r.ssrPath),"md"===d&&r.mdPath&&i.push(r.mdPath),i.push(n);const s=t.join(...i);try{o=e.readFileSync(s,{encoding:"utf8",flag:"r"})}catch(e){console.log("No Canvas File Found. Try using the assetPath option!",e)}}else console.log("If you're running this plugin via serverside renering, you'll need to define an ssrPath relative to your project file. Take a look at the readme or nextjs project for examples.");return null===o?"":o}export{b as default,b as rehypeJsonCanvas};
//# sourceMappingURL=index.js.map
