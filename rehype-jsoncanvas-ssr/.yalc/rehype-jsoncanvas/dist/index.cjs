var e=require("hastscript"),t=require("fs"),n=require("mdast-util-from-markdown"),r=require("mdast-util-to-hast");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=/*#__PURE__*/o(t);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},s.apply(null,arguments)}const u={html:"http://www.w3.org/1999/xhtml",mathml:"http://www.w3.org/1998/Math/MathML",svg:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function f(t,n){const r=function(t,n){switch(t.nodeType){case 1:return function(t,n){const r=t.namespaceURI,o=r===u.svg?e.s:e.h,i=r===u.html?t.tagName.toLowerCase():t.tagName,s=r===u.html&&"template"===i?t.content:t,f=t.getAttributeNames(),d={};let h=-1;for(;++h<f.length;)d[f[h]]=t.getAttribute(f[h])||"";return o(i,d,c(s,n))}(t,n);case 3:return function(e){return{type:"text",value:e.nodeValue||""}}(t);case 8:return function(e){return{type:"comment",value:e.nodeValue||""}}(t);case 9:case 11:return function(e,t){return{type:"root",children:c(e,t)}}(t,n);case 10:return{type:"doctype"};default:return}}(t,n);return r&&n.afterTransform&&n.afterTransform(t,r),r}function c(e,t){const n=e.childNodes,r=[];let o=-1;for(;++o<n.length;){const e=f(n[o],t);void 0!==e&&r.push(e)}return r}const d=new DOMParser,h=function(e){if(null==e)return l;if("function"==typeof e)return a(e);if("object"==typeof e)return Array.isArray(e)?function(e){const t=[];let n=-1;for(;++n<e.length;)t[n]=h(e[n]);return a(function(...e){let n=-1;for(;++n<t.length;)if(t[n].apply(this,e))return!0;return!1})}(e):function(e){const t=e;return a(function(n){const r=n;let o;for(o in e)if(r[o]!==t[o])return!1;return!0})}(e);if("string"==typeof e)return t=e,a(function(e){return e&&e.type===t});var t;throw new Error("Expected function, string, or object as test")};function a(e){return function(t,n,r){return Boolean(function(e){return null!==e&&"object"==typeof e&&"type"in e}(t)&&e.call(this,t,"number"==typeof n?n:void 0,r||void 0))}}function l(){return!0}const g=[],v=!1;function m(e){return void 0===e&&(e={}),{openEmbededInNewTab:void 0===e.openEmbededInNewTab||e.openEmbededInNewTab,renderMode:void 0===e.renderMode?"canvas":e.renderMode,canvasBuffer:void 0===e.canvasBuffer?30:e.canvasBuffer,nodeStrokeWidth:void 0===e.nodeStrokeWidth?3:e.nodeStrokeWidth,lineStrokeWidth:void 0===e.lineStrokeWidth?5:e.lineStrokeWidth}}var p=[];function y(e){var t=p.every(function(e){return e.complete});if(console.group("Images loading",p,t),p.length<1)return e();t?e():y(e)}function w(t,o){var i,u,f,c,d=m(o),h=(i=Infinity,u=Infinity,f=-Infinity,c=-Infinity,t.getNodes().forEach(function(e){i=Math.min(i,e.x),u=Math.min(u,e.y),f=Math.max(f,e.x+e.width),c=Math.max(c,e.y+e.height)}),{canvasWidth:f-i,canvasHeight:c-u,offsetX:-i,offsetY:-u}),a=function(t,n,r){var o=m(void 0);console.log(o);var i=s({},{version:"1.1",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":o.lineStrokeWidth,"fill-rule":"evenodd",fill:"currentColor",stroke:"currentColor"},{width:t,height:n,viewBox:"0 0 "+t+" "+n});return e.s("svg",i)}(h.canvasWidth+h.offsetX,h.canvasHeight+h.offsetY);return null===a?null:(t.getNodes().forEach(function(t){!function(t,o,i){try{var s=m(i),u="rgba(255, 255, 255, .5)",f="rgba(0,0,0,1)";"1"===o.color?(u="rgba(255, 0, 0, .5)",f="rgba(255,0,0,1)"):"2"===o.color?(u="rgba(255, 100, 0, .5)",f="rgba(255,100,0,1)"):"3"===o.color?(u="rgba(255, 255, 0, .5)",f="rgba(255,255,0,1)"):"4"===o.color?(u="rgba(0, 255, 100, .5)",f="rgba(0,100,0,1)"):"5"===o.color?(u="rgba(0, 255, 255, .5)",f="rgba(0,255,255,1)"):"6"===o.color&&(u="rgba(100, 10, 100, .5)",f="rgba(100,10,100,1)");var c=e.s("g"),d=e.s("rect",{x:o.x+t.properties.width/2,y:o.y+t.properties.height/2,width:o.width,height:o.height,rx:5,ry:5,stroke:f,fill:u,"stroke-width":s.lineStrokeWidth});return c.children.push(d),function(t,n){try{if("file"===n.type&&t&&n.file.match(/\.(jpg|jpeg|png|gif)$/i)){var r=e.s("image",{x:n.x,y:n.y,width:n.width,height:n.height,"xlink:href":n.file});t.children.push(r)}return Promise.resolve()}catch(e){return Promise.reject(e)}}(t,o),function(t,o){try{var i=function(){if("file"===o.type&&t){var i=function(){if(o.file.match(/\.(md|mdx)$/i))return Promise.resolve(fetch(o.file)).then(function(i){return Promise.resolve(i.text()).then(function(i){var s=n.fromMarkdown(i),u=r.toHast(s),f=e.s("foreignObject",{x:o.x,y:o.y,width:o.width,height:o.height});f.children.push(u),t.children.push(f)})})}();if(i&&i.then)return i.then(function(){})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}(t,o),t.children.push(c),Promise.resolve()}catch(e){return Promise.reject(e)}}(a,t,d)}),t.getEdges().forEach(function(n){var r=t.getNodes().find(function(e){return e.id===n.fromNode}),o=t.getNodes().find(function(e){return e.id===n.toNode});void 0!==o&&void 0!==r&&function(t,n,r,o,i){var s=m(i);if(null!==t&&null!=t){var u=t.properties.width||1,f=t.properties.height||1;if(r&&n){var c=r.x+("top"==o.fromSide||"bottom"==o.fromSide?r.width/2:r.width)+u/2,d=r.y+r.height/2+f/2,h=n.x+("top"==o.toSide||"bottom"==o.toSide?n.width/2:n.width)+u/2,a=n.y+n.height/2+f/2;"left"===o.fromSide?c=r.x+u/2:"top"===o.fromSide?d=r.y+f/2:"bottom"===o.fromSide&&(d=r.y+r.height+f/2),"right"===o.toSide?h=n.x+n.width+u/2:"top"===o.toSide?a=n.y+f/2:"bottom"===o.toSide?a=n.y+n.height+f/2:"left"===o.toSide&&(h=n.x+u/2);var l={x:c,y:a},g={x:h,y:d},v=e.s("path",{d:"M "+c+" "+d+" C "+l.x+" "+l.y+", "+g.x+" "+g.y+", "+h+" "+a,stroke:"black","stroke-width":s.lineStrokeWidth,fill:"none"});t.children.push(v)}}}(a,o,r,n,d)}),y(function(){return function(e,t){var n=m(void 0);return console.log("Rendering",e,n),null}(a)}))}var b=Object.defineProperty,x=(e,t,n)=>(((e,t,n)=>{t in e?b(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class S{constructor(e,t){x(this,"nodes",[]),x(this,"edges",[]),e&&(this.nodes=e),t&&(this.edges=t)}addNode(e){if(this.nodes.find(t=>t.id===e.id))throw new Error("A node with the same ID already exists in this.nodes");this.nodes.push(e)}addEdge(e){if(this.edges.find(t=>t.id===e.id))throw new Error("An edge with the same ID already exists in this.edges");this.edges.push(e)}getNode(e){return this.nodes.find(t=>t.id===e)}getEdge(e){return this.edges.find(t=>t.id===e)}getNodes(){return this.nodes}getEdges(){return this.edges}removeNode(e){this.nodes=this.nodes.filter(t=>t.id!==e),this.edges=this.edges.filter(t=>t.fromNode!==e&&t.toNode!==e)}removeEdge(e){this.edges=this.edges.filter(t=>t.id!==e)}toString(){return JSON.stringify({nodes:this.nodes,edges:this.edges})}static fromString(e){const t=JSON.parse(e);return new S(t.nodes,t.edges)}}var k="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function N(e,t,n){if(!e.s){if(n instanceof j){if(!n.s)return void(n.o=N.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(N.bind(null,e,t),N.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var j=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{N(r,1,i(this.v))}catch(e){N(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?N(r,1,t?t(o):o):n?N(r,1,n(o)):N(r,2,o)}catch(e){N(r,2,e)}},r},e}();function P(e){return e instanceof j&&1&e.s}var E=function(){return function(e){try{var t=[];!function(e,n,r,o){let i,s,u;s="element",u=function(e,n){console.log(e,n),"img"===e.tagName&&void 0!==n&&(console.log("Adding",e),t.push(e))},i=void 0,function(e,t,n,r){let o;o="element";const i=h("element");!function e(t,r,o){const s=t&&"object"==typeof t?t:{};if("string"==typeof s.type){const e="string"==typeof s.tagName?s.tagName:"string"==typeof s.name?s.name:void 0;Object.defineProperty(u,"name",{value:"node ("+t.type+(e?"<"+e+">":"")+")"})}return u;function u(){let s,u,f,c=g;if(i(t,r,o[o.length-1]||void 0)&&(c=function(e){return Array.isArray(e)?e:"number"==typeof e?[!0,e]:null==e?g:[e]}(n(t,o)),c[0]===v))return c;if("children"in t&&t.children){const n=t;if(n.children&&"skip"!==c[0])for(u=0,f=o.concat(n);u>-1&&u<n.children.length;){if(s=e(n.children[u],u,f)(),s[0]===v)return s;u="number"==typeof s[1]?s[1]:u+1}}return c}}(e,void 0,[])()}(e,0,function(e,t){const n=t[t.length-1],r=n?n.children.indexOf(e):void 0;return u(e,r)})}(e);var n=function(e,t,n){if("function"==typeof e[k]){var r,o,i,s=e[k]();if(function e(n){try{for(;!(r=s.next()).done;)if((n=t(r.value))&&n.then){if(!P(n))return void n.then(e,i||(i=N.bind(null,o=new j,2)));n=n.v}o?N(o,1,n):o=n}catch(e){N(o||(o=new j),2,e)}}(),s.return){var u=function(e){try{r.done||s.return()}catch(e){}return e};if(o&&o.then)return o.then(u,function(e){throw u(e)});u()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var f=[],c=0;c<e.length;c++)f.push(e[c]);return function(e,t,n){var r,o,i=-1;return function n(s){try{for(;++i<e.length;)if((s=t(i))&&s.then){if(!P(s))return void s.then(n,o||(o=N.bind(null,r=new j,2)));s=s.v}r?N(r,1,s):r=s}catch(e){N(r||(r=new j),2,e)}}(),r}(f,function(e){return t(f[e])})}(t,function(e){var t=e.properties.src;return console.log("Detected",t),Promise.resolve(function(e){try{var t=function(){return null===n?"":n},n="Loading",r=e.trim().toLowerCase(),o=function(){if(r.startsWith("https://")||"undefined"!=typeof window)return Promise.resolve(fetch(e).then(function(e){return e.text()}).then(function(e){return n=e})).then(function(){});n=i.default.readFileSync(e,{encoding:"utf8",flag:"r"})}();return Promise.resolve(o&&o.then?o.then(t):t())}catch(e){return Promise.reject(e)}}(t)).then(function(t){console.log("Got markdown",t);var n,r=S.fromString(t);console.log("Validate!",r),n=w(r,{}),console.log(n);var o,i,u=(o="<img alt='' src='"+n+"' style='width:100%' />",i={fragment:!0},f(i?.fragment?function(e){const t=document.createElement("template");return t.innerHTML=e,t.content}(o):d.parseFromString(o,"text/html"),{})||{type:"root",children:[]});e.properties=s({},e.properties),e.tagName="div",e.children=u.children})});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}};exports.default=E,exports.rehypeJsonCanvas=E;
//# sourceMappingURL=index.cjs.map
